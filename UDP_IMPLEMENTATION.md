# 全ボディ座標UDP送信機能 - 実装完了

## 実装内容

### データ設計（最小ヘッダー）

**パケット構造:**
```
┌─────────────────────────────────────┐
│ Header (2 bytes)                    │
│  - robot_id: 1 byte (1=Main, 2=Enemy)│
│  - num_bodies: 1 byte               │
├─────────────────────────────────────┤
│ Body 0: [X, Y, Z, Roll, Pitch, Yaw] │ 24 bytes
│ Body 1: [X, Y, Z, Roll, Pitch, Yaw] │ 24 bytes
│ Body 2: [X, Y, Z, Roll, Pitch, Yaw] │ 24 bytes
│ ...                                 │
│ Body N: [X, Y, Z, Roll, Pitch, Yaw] │ 24 bytes
└─────────────────────────────────────┘
```

**設計のポイント:**
- ヘッダーはわずか2バイト（最小限）
- ロボットID（1バイト）で2つのロボットを明確に区別
- ボディ数（1バイト）で最大255ボディまで対応
- 各ロボットのパケットは独立（片方のロスが他方に影響しない）

### 変更ファイル

#### 1. `udp_vs_merimujoco_walk.py`
**追加機能:**
- `get_body_pose()`: 任意のボディのXYZ+RPYを取得
- `send_robot_all_bodies_udp()`: 1ロボット分の全ボディデータをUDP送信
- 起動時に各ロボットのボディリストを自動生成
- メインループで2ロボット分を独立送信

**送信タイミング:**
- MuJoCoの各ステップ（約1000Hz @ timestep=0.001）
- Main Robot → Enemy Robot の順で2パケット送信

#### 2. `udp_receiver_test.py`
**新機能:**
- パケット解析: robot_idとnum_bodiesを自動認識
- 2ロボットのデータを区別して保存
- リアルタイム表示: 1行でコンパクトに表示
- 詳細表示: 100パケットごとに各ロボットの詳細情報

**表示モード:**
1. **リアルタイム（1行）**: 各ロボットのベースボディ座標
2. **詳細（100パケット毎）**: 各ロボットの最初の5ボディの詳細座標

#### 3. `UDP_README.md`
全面更新して新フォーマットに対応

## 使用例

### ターミナル1: シミュレーション起動
```bash
python udp_vs_merimujoco_walk.py
```

**出力例:**
```
[Setup] Main robot bodies: 20
[Setup] Enemy robot bodies: 20
[Setup] Total UDP packet size per robot: 482 bytes (main), 482 bytes (enemy)
[Main] Starting walking simulation. Press Ctrl+C to stop.
[Main] Sending robot poses to UDP 127.0.0.1:27000
```

### ターミナル2: データ受信
```bash
python udp_receiver_test.py
```

**出力例:**
```
[Main Robot] Bodies:20 | Pos:( 0.000, 0.000, 0.350) RPY:(  0.1, -2.3, 89.5) | [Enemy Robot] Bodies:20 | Pos:( 1.500, 0.000, 0.350) RPY:( -0.2,  1.8,-90.2)
====================================================================================================
[Main Robot]
  Total bodies: 20
    Body  0: Pos=(  0.000,   0.000,   0.350) RPY=(   0.12,  -2.34,  89.52)
    Body  1: Pos=(  0.050,   0.020,   0.280) RPY=(   1.23,  -1.45,  88.67)
    Body  2: Pos=( -0.030,   0.015,   0.250) RPY=(  -0.45,  -2.11,  90.33)
    ...
[Enemy Robot]
  Total bodies: 20
    Body  0: Pos=(  1.500,   0.000,   0.350) RPY=(  -0.21,   1.82, -90.18)
    ...
```

## パフォーマンス

### 通信量
- 20ボディ/ロボット: 482バイト/パケット × 2ロボット = 964バイト/フレーム
- 1000Hz送信: 約964KB/秒 = 7.7Mbps（ローカル通信なら余裕）

### 効率性
- ヘッダーオーバーヘッド: わずか2バイト（0.4%）
- バイナリ形式: テキストの約1/4のサイズ
- パケット独立: ロスの影響を最小化

## データの活用例

### 1. リアルタイム可視化
受信データを3Dビューアで表示

### 2. モーションキャプチャ
全ボディ座標を記録してモーション再生

### 3. 機械学習
ロボットの動作データを学習用データセットに

### 4. 対戦ゲーム
2ロボットの位置関係を判定して対戦ゲーム化

## まとめ

✅ 2つのロボットを明確に区別（robot_id）
✅ 全ボディ座標を送信（XYZ + RPY）
✅ 最小限のヘッダー設計（2バイト）
✅ 高速通信対応（約1000Hz）
✅ 受信側で詳細表示機能

全ボディ座標のリアルタイムUDP送信機能が完成しました！
